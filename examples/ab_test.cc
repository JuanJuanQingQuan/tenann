#include "sstream"
#include "tenann/factory/ann_searcher_factory.h"
#include "tenann/factory/index_factory.h"
#include "tenann/index/index_cache.h"
#include "tenann/store/index_meta.h"
#include "tenann/util/pretty_printer.h"
#include "tenann/util/runtime_profile.h"
#include "tenann/util/runtime_profile_macros.h"

int main(int argc, char const* argv[]) {
  using namespace tenann;

  IndexMeta meta;
  meta.SetMetaVersion(0);
  meta.SetIndexFamily(IndexFamily::kVectorIndex);
  meta.SetIndexType(IndexType::kFaissHnsw);
  meta.common_params()["metric_type"] = MetricType::kL2Distance;
  meta.common_params()["dim"] = 768;
  meta.common_params()["is_vector_normed"] = false;

  auto profile = new RuntimeProfile("root");
  auto init_timer = T_ADD_TIMER(profile, "round1");
  auto avg_timer = T_ADD_TIMER(profile, "round2-11");

  // if (argc != 2) {
  //   std::cout << "usage: ab_test [index_path]\n";
  //   exit(-1);
  // }
  // auto index_path = argv[1];

  auto index_path = "new.vi";

  std::vector<float> query = {
      -0.97337455,  0.3818826,     0.75329053,   0.30747733,   1.3792602,    -0.67760515,
      0.109889515,  -0.043603893,  -0.34756684,  -0.54237086,  -0.40367392,  0.020233376,
      -0.3710026,   -0.26650375,   -0.079042695, -0.70723575,  0.06537717,   0.022540467,
      -0.20279314,  -0.8228854,    -0.35902768,  -0.5982273,   0.16731228,   0.06561827,
      -1.1499759,   -0.2498522,    -0.28461397,  -0.41338497,  -0.2139953,   0.19872746,
      0.105372734,  0.5066735,     -0.010133049, 0.8045353,    -0.48088092,  0.2720276,
      0.114456534,  0.16527168,    0.4276575,    -0.9073271,   -0.5833761,   1.0034177,
      -1.733297,    -0.32572848,   -1.5580604,   0.28816107,   0.7537629,    0.06372871,
      -0.7971183,   -0.43239778,   0.2769816,    1.8850759,    0.37175268,   1.098962,
      -0.31663904,  -0.32143512,   -0.20530231,  0.44306383,   0.2118331,    0.3750884,
      -0.07786991,  -1.225342,     -0.59994394,  -1.7232639,   1.0486544,    0.2023999,
      0.06612556,   0.084692515,   0.5340303,    -0.26106235,  0.25325888,   0.33524498,
      0.48186454,   -0.025986647,  0.71582645,   0.15228733,   0.109959826,  0.30154607,
      -0.034611456, -0.67718405,   -1.0592998,   -0.42587313,  -0.038229827, -0.032471817,
      0.08167684,   -0.62296057,   0.28777537,   -0.690299,    0.52222764,   -0.91973126,
      -0.10816259,  0.84493166,    0.02760853,   -0.11714029,  -0.35432515,  0.54382473,
      0.41043943,   -0.08368678,   0.36402288,   -0.9937116,   -0.33181182,  0.026317043,
      -1.0305054,   0.66850173,    -0.22466983,  -0.028882096, 0.57650656,   0.05997261,
      0.6342544,    0.6339068,     -1.0083755,   -0.17753443,  0.65601474,   1.5503057,
      -0.59296936,  -0.45112258,   0.091984116,  0.28018135,   -0.20937085,  0.4728604,
      0.8710638,    -0.13282898,   0.048173152,  1.3318619,    -0.92675906,  0.47316122,
      -0.2355913,   -0.08866308,   0.69410676,   0.65606356,   0.23950012,   -0.7748966,
      0.7023572,    -1.3418013,    -0.39441872,  -0.16224405,  -0.31520176,  0.02425127,
      -1.0294703,   -0.30580133,   0.43523684,   -0.62819564,  -0.09534322,  0.3151906,
      -0.040446807, 0.8723983,     0.4444733,    -0.20960358,  -0.23388277,  0.37378636,
      -0.7795524,   -0.12976143,   -0.21295752,  0.38082084,   0.6662866,    1.1063026,
      -0.07972378,  -0.057798527,  -0.22018361,  0.35710454,   0.44209957,   0.44402748,
      -0.022524053, 0.5927907,     0.54779875,   -0.5318071,   0.56893665,   -0.5043681,
      -0.56810504,  -0.6815646,    -0.13116612,  0.5046808,    0.15943944,   0.4708837,
      -0.2866346,   -0.578822,     -1.8464911,   0.61295277,   -0.3402078,   -0.18573456,
      0.23278138,   -0.6151145,    0.4166329,    -0.7411834,   -0.20832229,  0.08280543,
      -0.42367154,  -1.1232725,    -0.5850026,   -0.068434425, 0.98612744,   1.4745668,
      -0.29401976,  -0.6344035,    0.44435114,   -0.57341444,  -0.1467024,   -0.25280604,
      -0.70604295,  -0.5931674,    -0.05441871,  0.29096675,   0.016152192,  -0.04131356,
      -1.0327009,   0.0032309506,  -0.90762407,  -1.1642034,   -0.43894124,  -0.5732917,
      0.011596041,  -0.21130416,   -0.16001211,  0.15903425,   0.06486934,   0.20189309,
      -0.7332131,   -0.1367852,    0.5197751,    -0.8959092,   -0.48146302,  0.10537759,
      0.01932377,   0.27900848,    1.1260083,    0.20940587,   -0.5408355,   0.13535014,
      0.11188234,   -0.15798794,   0.7941057,    -0.05085848,  -0.49751043,  -0.11555725,
      -0.08543575,  -0.74961007,   0.65406007,   0.25503725,   -1.1060772,   -1.116176,
      -0.242538,    0.3532763,     -0.4178605,   -0.32337692,  0.3386542,    0.1887225,
      0.29280958,   0.37600842,    0.9540075,    -0.010322958, 0.6799388,    -0.86722714,
      -0.23455834,  -0.53993905,   0.26393378,   0.03645568,   -0.28664368,  -0.7003854,
      -0.1111215,   -0.8874067,    0.44503322,   0.023763733,  0.33876058,   -0.70153624,
      -0.056920197, -0.22240934,   -0.35770497,  0.27352542,   -0.18483005,  -0.35244066,
      -0.2017667,   0.25829783,    -0.8021709,   -0.2621685,   -0.540719,    -0.2634743,
      -0.22638793,  0.11415955,    -0.8649282,   0.3439918,    0.6910243,    0.61057895,
      0.3450501,    -0.23021124,   -0.22895153,  -0.44692823,  -0.44358164,  1.196752,
      1.2147453,    0.14213371,    0.0070031807, -0.7081887,   -0.16855471,  0.2875805,
      1.6584303,    -0.06649345,   0.37579402,   0.44289443,   1.0480772,    -0.52758986,
      -0.36203936,  0.37351865,    -0.52976704,  0.30997866,   -0.5551207,   -0.7919793,
      0.65246886,   1.2312897,     -1.6483059,   1.0998476,    -1.5558015,   -0.25864547,
      0.5022441,    0.11246566,    0.43261597,   0.8643442,    -0.53866255,  -0.15956976,
      0.94549,      -0.5768393,    -0.39655513,  1.7475348,    0.25433433,   0.93134516,
      0.98746735,   0.29219148,    0.33229327,   -0.24210031,  0.87892544,   0.721744,
      0.253912,     0.62399256,    0.13127492,   0.49245113,   -0.68111944,  0.58892524,
      -0.4309731,   0.7767082,     -0.24391392,  -0.034756877, 0.36514708,   -1.2569913,
      -0.23743074,  -0.8694175,    0.25082794,   -0.3158085,   0.8782916,    0.63798887,
      -0.73881686,  0.8545955,     -0.8280932,   0.38501957,   0.080609724,  -0.2859334,
      -1.6807035,   -1.1888684,    0.09866856,   -0.36098334,  0.06328479,   -0.33972457,
      1.2625343,    -0.51207334,   -0.39307234,  -0.5794393,   0.3564105,    -0.598138,
      0.61674756,   -0.13199748,   -1.3860887,   -0.3161072,   0.02392364,   0.13092998,
      0.82388556,   -0.18970051,   -0.4184494,   -0.5245049,   -0.4411251,   1.3005022,
      0.15229507,   -0.9709388,    -1.7495984,   -1.1811734,   0.20795028,   0.2420484,
      -0.36476573,  -0.55298865,   -0.6118253,   -1.1366043,   -0.968844,    -0.2244608,
      -0.43514055,  0.3234816,     0.21970594,   -0.40118316,  1.3144261,    0.20142828,
      -0.09661283,  0.06786115,    -0.6336051,   0.05438633,   -0.3210599,   -0.5653573,
      0.56853944,   0.28503188,    1.167698,     0.4038736,    0.79312795,   -0.2861225,
      1.7754555,    1.237398,      -1.0837152,   0.72143066,   0.20343497,   -0.3585233,
      -0.2596137,   0.34447262,    0.63180953,   0.60371697,   0.51635295,   -1.0077984,
      -1.3386322,   0.08942552,    0.33446583,   -1.1471031,   0.099991016,  0.17759487,
      0.023342365,  -0.5914856,    0.12844968,   0.46453556,   0.33539358,   0.7453334,
      0.47078708,   0.040493723,   -0.41714936,  0.48391792,   -0.70951265,  0.42629364,
      0.08693851,   0.20890106,    0.063712575,  0.15537174,   -0.44643757,  -0.31019184,
      -0.4920185,   0.5067707,     0.08383276,   0.5872727,    0.6920236,    -0.86336577,
      0.3936023,    0.15858047,    -0.73623437,  -1.1739534,   -0.16069056,  0.60614634,
      -0.6659234,   -0.2751066,    -0.239195,    0.7136993,    -0.2713512,   -0.52388746,
      0.43598208,   0.36152777,    0.99533683,   -0.10586385,  0.45501766,   0.72334915,
      0.4041936,    -0.750782,     -0.45220143,  -0.026577739, -0.03822014,  0.3603504,
      -0.04218823,  -1.0325364,    -0.11522041,  -0.5832786,   -0.80020565,  0.6939753,
      0.6541725,    -0.7330455,    -0.5692238,   0.4677733,    0.61664,      -0.2024542,
      0.66644394,   1.1638364,     0.3707652,    0.7492842,    -1.3498114,   0.2690847,
      0.79622257,   -0.24373138,   -0.5022112,   -0.7757999,   0.08852657,   -0.78041774,
      -0.1311544,   0.64689237,    0.47616318,   -0.5970772,   0.21720636,   -0.1800199,
      0.61504287,   -0.018822491,  -0.34370974,  -0.68650514,  0.703137,     0.31658322,
      0.02469028,   0.047981825,   0.60555935,   0.8198862,    0.8005085,    0.71684426,
      0.06650402,   -0.46050903,   0.08118921,   0.19489273,   -0.69994247,  -0.2870136,
      0.39861313,   0.025152136,   0.113135576,  0.69435567,   -0.5171907,   -0.29748088,
      0.9145776,    1.76256,       -0.6638381,   0.40993592,   -0.8531024,   1.0717552,
      -0.6620471,   0.4184769,     -0.6999847,   -0.6212188,   0.782694,     -0.71888596,
      -0.33228022,  -0.36197096,   0.57119983,   0.47048324,   -0.3821322,   0.110257074,
      0.19225208,   -0.45927185,   0.5765917,    0.1351266,    -0.33068338,  -0.18296735,
      -0.8603626,   0.1407657,     -0.68731254,  -0.5066492,   -0.36570477,  -0.07088174,
      0.24143694,   -1.6830311,    -0.0547198,   -0.35879603,  -0.7281746,   -0.8530035,
      -0.8596712,   -1.1822261,    0.6385584,    -0.7643818,   0.45391712,   -0.70023376,
      0.23619547,   0.57075536,    -0.23266706,  -1.0586655,   0.009794669,  -0.05004257,
      0.46483943,   -0.13686214,   0.011046612,  0.577661,     -0.19481483,  0.24996364,
      -0.11953612,  0.07613696,    -0.051988874, -0.33786458,  0.4943851,    0.045841247,
      0.2047645,    -0.13752687,   1.7427112,    0.39979884,   -1.1740288,   -0.39878795,
      -0.2806031,   -0.24159719,   0.6264144,    0.8181344,    -0.94820297,  0.72866565,
      0.5220272,    1.2506866,     0.2591117,    0.24576584,   0.11243758,   -0.451853,
      0.28367406,   -0.5283231,    0.23702277,   -0.98449117,  -0.9821979,   -0.5237953,
      0.6660465,    0.38068193,    -0.99150765,  0.8198889,    -0.42116737,  0.39340207,
      -0.6551105,   -0.18807782,   -0.1240041,   -0.033827476, -0.9255534,   -0.87530553,
      0.93528026,   -0.1406299,    0.5119296,    0.8630286,    0.2303857,    0.06681941,
      -0.1938422,   1.4258782,     0.91743577,   -0.07697438,  0.199055,     0.36336693,
      -0.15687123,  -0.16418172,   -0.4282446,   0.23320751,   0.073757276,  0.50677544,
      -0.15034728,  -0.0006057556, -0.41269177,  0.30148548,   0.11677372,   0.48218447,
      -0.6902879,   -0.61622065,   -0.56611884,  0.3037373,    0.8792133,    1.095856,
      -0.3616481,   -0.34340855,   0.2802508,    0.24289457,   -0.540744,    0.06694494,
      0.4861869,    -0.16913517,   -0.89607376,  -0.38237348,  -0.7461274,   0.046112936,
      0.773321,     -0.95809567,   -0.14637211,  0.48441118,   -0.29362932,  0.4335856,
      -0.48443657,  -1.0880042,    -0.1848361,   1.2498157,    -1.2273769,   0.41568527,
      -0.25672668,  -1.5570081,    -0.21703671,  0.080652714,  0.71752393,   0.80750054,
      -0.21955459,  -0.08937895,   -0.048328485, -0.18024519,  -0.23166993,  -0.9720929,
      0.08537829,   1.5341606,     0.14195594,   -0.593106,    -0.23012999,  3.3855188,
      0.16360763,   -0.22229227,   0.0012942468, 1.0599566,    0.19087617,   0.41869593,
      0.2236848,    -0.7646815,    0.17204106,   -0.59294695,  0.046644617,  -0.015747579,
      0.89866275,   0.2519861,     -0.82197446,  0.48483878,   0.54645056,   0.29829648,
      0.61656636,   0.13055699,    -0.40879664,  0.7049176,    -1.337185,    -0.9023676,
      0.5235945,    0.7808914,     0.14196591,   0.13724011,   0.085815646,  0.82664865,
      0.8632943,    0.6462302,     0.7091441,    0.627644,     0.19949253,   0.07205927,
      0.7591542,    -0.2785686,    -0.11672175,  1.104327,     0.37479973,   -0.42822844,
      0.7090573,    0.010624006,   0.6328264,    0.63391095,   0.2951246,    0.57817614,
      -0.62963283,  -0.111329354,  0.043948915,  0.03831873,   0.5027131,    -0.08310237,
      -0.2668416,   1.4208422,     0.39751887,   -0.7496695,   0.46936184,   0.090377994,
      2.7160168,    0.123073444,   1.2969011,    1.1929313,    0.06134045,   -0.3077534,
      0.26063007,   0.6668686,     -1.0619981,   -0.5235813,   0.071661785,  -0.030042576};

  auto query_view = PrimitiveSeqView{
      .data = reinterpret_cast<uint8_t*>(query.data()),
      .size = static_cast<uint32_t>(query.size()),
      .elem_type = PrimitiveType::kFloatType,
  };
  std::vector<int64_t> results(10);

  {
    T_SCOPED_TIMER(init_timer);
    auto ann_searcher = AnnSearcherFactory::CreateSearcherFromMeta(meta);
    std::shared_ptr<IndexReader> index_reader = IndexFactory::CreateReaderFromMeta(meta);
    ann_searcher->SetIndexReader(index_reader)
        .SetIndexCache(IndexCache::GetGlobalInstance())
        .ReadIndex(index_path, true);

    ann_searcher->AnnSearch(query_view, 10, results.data());
  }
  std::cout << results[1];

  for (int i = 1; i <= 100; i++) {
    T_SCOPED_TIMER(avg_timer);
    auto ann_searcher = AnnSearcherFactory::CreateSearcherFromMeta(meta);
    std::shared_ptr<IndexReader> index_reader = IndexFactory::CreateReaderFromMeta(meta);
    ann_searcher->SetIndexReader(index_reader)
        .SetIndexCache(IndexCache::GetGlobalInstance())
        .ReadIndex(index_path, true);
    ann_searcher->AnnSearch(query_view, 10, results.data());
    std::cout << results[1];
  }

  std::cout << "\n";
  std::cout << "Cold Run: "
            << PrettyPrinter::print(init_timer->value() / 1000 / 1000, TUnit::TIME_MS) << "\n";

  std::cout << "Hot Run (100 rounds, AVG): "
            << PrettyPrinter::print(avg_timer->value() / 1000 / 1000 / 100, TUnit::TIME_MS) << "\n";
  return 0;
}
